# CWE-78: OS 명령어 삽입 (OS Command Injection)

## 📌 개요  
CWE-78은 **운영 체제 명령어를 실행할 때 외부 입력값을 적절히 검증하지 않아**  
공격자가 악의적인 명령어를 삽입하거나 변조하여  
시스템에서 의도하지 않은 명령을 실행하도록 만드는 취약점입니다.

이 예제는 **SPICE 프로젝트의 vd_agent 컴포넌트**에서 발생한  
[CVE-2017-15108 (commit: 8ba174816d245757e743e636df357910e1d5eb61)]의  
패치 이전 버전을 그대로 덤프한 코드입니다.  
**파일 전송 완료 후 저장 디렉토리를 여는 과정에서 발생한 쉘 인젝션 취약점**을 포함하고 있습니다.

---

## 🛠 주요 원인  

- 외부 입력인 `xfers->save_dir` 경로를 명령어 문자열로 조합  
- `snprintf()`를 통해 `system()` 함수로 전달 → **쉘 해석 발생**
- 입력 검증 없이 쉘 명령어 실행에 포함됨 → **명령어 삽입 가능**

---

## 📂 포함된 파일  

| 파일명 | 설명 |
|--------|------|
| `file-xfers.c` | SPICE 프로젝트의 vd_agent 컴포넌트에서 사용되는 전체 소스코드 (패치 전 버전) |

---

## 🚨 취약 코드 (BadSink)  

📌 **발생 위치**: `file-xfers.c`  
📌 **함수**: `vdagent_file_xfers_data(...)`  
📌 **패치 전 코드**:
```c
char buf[PATH_MAX];
snprintf(buf, PATH_MAX, "xdg-open '%s'&", xfers->save_dir); // ❌ 쉘 명령어 조합
status = system(buf); // ❌ CWE-78: 명령어 삽입 가능
```

📌 **문제점 요약**:
- 공격자가 `save_dir` 값에 쉘 제어 문자를 삽입하면 시스템 명령어가 실행될 수 있음  
- 예: `xfers->save_dir = "/safe/dir; rm -rf /"` → 전체 시스템 삭제 위험  
- `system()`은 문자열 전체를 쉘에 넘기므로 **절대 사용을 피해야 하는 함수**  

---

## ✅ 패치 이후 변경 사항 요약

- `system()` 사용 제거
- `g_spawn_async()` 함수로 교체하여 명령어와 인자를 명확히 분리
- 쉘 해석을 회피하여 입력값에 대한 안전성 확보

---

## 📚 참고 정보

- 🔗 [공식 커밋 링크](https://cgit.freedesktop.org/spice/linux/vd_agent/commit/?id=8ba174816d245757e743e636df357910e1d5eb61)
- 📖 CWE Reference: [CWE-78 on MITRE](https://cwe.mitre.org/data/definitions/78.html)

---