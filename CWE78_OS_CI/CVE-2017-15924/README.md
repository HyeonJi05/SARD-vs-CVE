# 📁 CVE-2017-15924

**🔗 [커밋 링크](https://github.com/shadowsocks/shadowsocks-libev/commit/c67d275803dc6ea22c558d06b1f7ba9f94cd8de3)** | **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2017-15924/)**

| 총 슬라이스 수* |  정탐 | 미탐 |
| --------  | -- | -- |
| 48개       | 0개 | 48개 |

\* cve 설명에 나온 취약한 함수(Caller)에 대한 슬라이스만 고려

## 🔍 취약점 설명
> shadowsocks-libev의 UDP를 통한 JSON configuration parsing 중 add_server(), build_config(), 그리고 construct_command_line() 에 걸쳐 발생한 OS Command Injection 취약점입니다.

* **취약 조건**: 입력값을 검증하지 않고
* **취약 동작**: 위험한 `system()` 함수 사용


### ❗️ 취약 코드

**문제점**:
입력이 적절히 검증되지 않은 채로 `system()` 함수의 인자로 사용되어 **명령어 인젝션**이 발생할 수 있음.

#### Trace: `before_manager.c:486`
네트워크 소켓 파일에서 각종 입력값 검증 되지 않은 method 값이 cmd 변수에 그대로 전달됨.
```c
static void
build_config(char *prefix, struct server *server){
        ...
        snprintf(path, path_size, "%s/.shadowsocks_%s.conf", prefix, server->port);
        FILE *f = fopen(path, "w+");
        ...
        if (server->method) fprintf(f, ",\n\"method\":\"%s\"", server->method);
        ...
}
construct_command_line(struct manager_ctx *manager, struct server *server){
        ...
        build_config(working_dir, server);

        if (server->method) method = server->method;
        memset(cmd, 0, BUF_SIZE);
        snprintf(cmd, BUF_SIZE,
                "%s -m %s --manager-address %s -f %s/.shadowsocks_%s.pid -c %s/.shadowsocks_%s.conf",
                executable, method, manager->manager_address,
                working_dir, server->port, working_dir, server->port); /* POTENTIAL FLAW */ 
}
```


#### Sink: `before_manager.c:134`
```c
add_server(struct manager_ctx *manager, struct server *server){
        ...
        char *cmd = construct_command_line(manager, server);
        if (system(cmd) == -1) { /* POTENTIAL FLAW */ 
        ...
}
```


### ✅ 개선 코드

**패치 위치**: `after_manager.c:142`
poc를 method 변수로 했기에 cmd에 method 변수를 안 넣는 방식으로 패치한 것 같습니다..
아무래도 다른 변수로 우회가 가능해 보입니다.

```c
static char *
construct_command_line(struct manager_ctx *manager, struct server *server){
        snprintf(cmd, BUF_SIZE,
                "%s --manager-address %s -f %s/.shadowsocks_%d.pid -c %s/.shadowsocks_%d.conf",
                executable, manager->manager_address, working_dir, port, working_dir, port);
}
```

**개선 방법**:
* 취약점에서 poc에 활용된 method 변수의 사용을 제거함.

## SARD와 탐지 결과 비교
KSignSlicer의 AI 모델은 SARD CWE78에 대해 슬라이스에 strcat()가 있을 때 취약으로 탐지해왔습니다. 그런데 이 취약점은 system()함수를 활용하여 정상으로 탐지된 것으로 보입니다.