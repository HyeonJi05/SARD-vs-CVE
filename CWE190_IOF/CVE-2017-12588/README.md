# 📁 CVE-2017-12588

## 🔍 취약점 개요

**🔗 [커밋 링크](https://github.com/rsyslog/rsyslog/commit/062d0c671a29f7c6f7dff4a2f1f35df375bbb30b)** | **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2017-12588/)**

> rsyslog 8.28.0 이전 버전의 `omzmq3` 및 `imzmq3` 모듈에서는 설명(description) 필드가 형식 문자열로 해석되는 문제가 존재합니다.  
> 이로 인해 공격자는 포맷 문자열 지정자를 포함한 입력을 통해 **형식 문자열 취약점(CWE-134)**을 유발할 수 있으며, 이는 서비스 거부 또는 메모리 조작과 같은 영향을 초래할 수 있습니다.

**취약점 종류**: \[[CWE-134](https://cwe.mitre.org/data/definitions/134.html)] Use of Externally-Controlled Format String

* **Source**: 설명 문자열(`info->description`) – 외부 입력에 의해 설정될 수 있음
* **취약 조건**: 설명(description) 문자열에 포맷 문자열 지정자(`%s`, `%x` 등)가 포함된 경우, 해당 문자열이 포맷 문자열로 직접 사용됨
* **Sink**: `zsocket_connect()`, `zsocket_bind()` – 내부적으로 `printf` 계열 함수에 format string으로 전달됨

## 📄 CVE-2017-12588 분석 대상 선정 요약

| 항목 | imzmq3.c | omzmq3.c | 비고 |
|------|----------|----------|------|
| 취약 함수 | zsocket_bind, zsocket_connect | 동일 | ✅ |
| 수정 방식 | 포맷 문자열 "%s" 추가 | 동일 | ✅ |
| 데이터 흐름 | 단일 함수 내 처리 | 동일 | ✅ |
| 구조 단순성 | 보통 | 더 단순 | 🔍 분석용 적합 |
| 대표성 | 충분 | 충분 | ✅ |

✅ **결론:** 구조가 단순한 `omzmq3.c`만 분석 대상으로 사용해도 충분함

---

## 📊 탐지 결과 요약

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
|----------------|----------------|----------------|
| 2개           | 0개            | 0개           |

\* CVE 설명에 나온 기준 함수(`Caller`: `createSocket`, `criterion`: `zsocket_connect`, `zsocket_bind`)는 슬라이스 목록에 존재하지 않음.

#### 📌 실제 슬라이스 Caller / Criterion 목록 (일부):

```
Caller: getSocketType  criterion: strcmp
Caller: getSocketAction  criterion: strcmp  
```

---

#### SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유

## 📌 CWE-134 탐지와 AI 모델 인식 한계 요약

### 1. AI 모델의 학습 방식

* 대부분의 CWE-134 학습은 **`sprintf`, `printf`, `fprintf`** 등 포맷 문자열이 직접 사용되는 호출 패턴을 중심으로 함
* `"sprintf(user_input)"` 형태가 대표적인 취약 패턴으로 인식됨

---

### 2. 실제 CVE의 코드 구조

* 포맷 문자열이 사용자 입력으로 직접 조합된 구조로 매우 전형적인 CWE-134 패턴
* 그러나 해당 슬라이스에서는 `"Sink": false`로 분류되어 AI가 취약 흐름을 탐지하지 못함

---

### ⚠️ 탐지 결과 문제점

1. **Sink 식별 실패**:

   * `sprintf` 호출이 있음에도 불구하고 `"Sink": false`로 태깅됨
   * 포맷 문자열 취약점을 일으키는 대표 함수임에도 탐지되지 않음
   * 📄 근거: `test_output.csv`

2. **입력 → Sink 흐름 미인식**:

   * 실제 취약한 `sprintf` 호출 구문이 슬라이스에 포함되지 않았음
   * 따라서 외부 입력이 Sink로 전달되는 흐름 자체가 분석 대상에서 누락됨
   * 이는 슬라이서가 `sprintf`를 기준 함수(criterion)로 인식하지 못했거나,
     해당 코드 블록이 슬라이스 추출 조건을 만족하지 못했기 때문
   * 📄 근거: `test_output.csv`

---

## ✅ 개선 방향 제안

1. **Sink 정의 정확도 향상**:

   * `sprintf`와 같은 고전적인 포맷 함수 호출이 탐지에서 누락되지 않도록 기준 강화 필요

2. **데이터 흐름 추적 정밀도 개선**:

   * `sprintf` 등 포맷 함수에 전달되는 인자가 외부 입력에서 유입된 경우,
     그 유입 경로를 슬라이서와 모델이 정확히 추적할 수 있도록 개선해야 함
   * 특히 포맷 문자열 인자가 사용자 제어값일 때, 이를 명확히 구분해 CWE-134 흐름으로 연결되도록 해야 함

3. **CWE-134 탐지 시 Threshold 완화**:

   * 토큰 수가 짧거나 간단한 슬라이스에서도 CWE-134 가능성을 반영하도록 조정

---

## 📁 취약점 세부 사항

| 파일명                | 설명           |
| ------------------ | ------------ |
| `before_credd.cpp` | 취약 코드 포함 파일  |
| `after_credd.cpp`  | 패치된 코드 포함 파일 |

### ❗️취약 코드

```c
rv = zsocket_connect(*sock, info->description);
rv = zsocket_bind(*sock, info->description);
```

* `info->description`은 외부 설정 파일 또는 입력을 통해 유입되는 사용자 제어 가능 문자열입니다.
* 해당 값이 포맷 문자열 자리에 직접 들어가므로, `%s`, `%x` 등의 포맷 지정자가 포함될 경우
  형식 문자열 취약점(CWE-134) 발생 가능

### ✅ 개선 코드

```diff
- rv = zsocket_connect(*sock, info->description);
+ rv = zsocket_connect(*sock, "%s", info->description);

- rv = zsocket_bind(*sock, info->description);
+ rv = zsocket_bind(*sock, "%s", info->description);
```

**개선 방법**:

* 포맷 문자열을 고정된 `"%s"`로 명시하여 외부 입력이 포맷으로 해석되지 않도록 조치
* 사용자 입력은 포맷 문자열의 인자(`"%s"`, `"%d"` 등)에만 전달되도록 구성해야 하며, **포맷 문자열 자체로 사용되어서는 안 됨**
#### 포맷 문자열: `"%s"`, `"%d"`, `"%x"` 같은 출력 형식 명령이 들어있는 문자열로, `sprintf`류 함수의 첫 번째 인자로 쓰이는 문자열
#### `printf`, `sprintf`, `fprintf` 같은 함수의 첫 번째 인자로 `user_input`이 들어가면 안된다는 의미